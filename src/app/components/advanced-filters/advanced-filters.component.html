<ion-card class="filters-card glass-premium premium-float">
  <ion-card-header class="filters-header">
    <div class="header-content">
      <div class="title-section">
        <ion-icon name="filter" color="secondary"></ion-icon>
        <h3>{{ config.title }}</h3>
        <span class="active-count" *ngIf="getActiveFiltersCount() > 0">
          {{ getActiveFiltersCount() }} activo{{ getActiveFiltersCount() !== 1 ? 's' : '' }}
        </span>
      </div>

      <div class="header-actions">
        <ion-button
          fill="clear"
          size="small"
          (click)="onToggle()"
          [disabled]="loading">
          <ion-icon [name]="isExpanded ? 'chevron-up' : 'chevron-down'"></ion-icon>
        </ion-button>
      </div>
    </div>
  </ion-card-header>

  <ion-card-content *ngIf="isExpanded" class="filters-content">
    <!-- Loading -->
    <div class="loading-container" *ngIf="loading">
      <ion-spinner name="crescent" color="secondary"></ion-spinner>
      <p>Cargando filtros...</p>
    </div>

    <!-- Filtros -->
    <div class="filters-grid" *ngIf="!loading">
      <div
        class="filter-item"
        *ngFor="let field of config.fields"
        [class.active]="isFieldActive(field.key)">

        <ion-item class="filter-input-item">
          <ion-label position="floating" color="secondary">
            {{ field.label }}
            <span class="active-indicator" *ngIf="isFieldActive(field.key)">●</span>
          </ion-label>

          <!-- Campo de texto -->
          <ion-input
            *ngIf="field.type === 'text'"
            [(ngModel)]="internalValues[field.key]"
            (ionInput)="onValueChange(field.key, $event.detail.value)"
            [placeholder]="field.placeholder"
            clearInput="true">
          </ion-input>

          <!-- Campo numérico -->
          <ion-input
            *ngIf="field.type === 'number'"
            type="number"
            [(ngModel)]="internalValues[field.key]"
            (ionInput)="onValueChange(field.key, $event.detail.value)"
            [placeholder]="field.placeholder"
            [attr.min]="field.min"
            [attr.max]="field.max"
            [step]="field.step">
          </ion-input>

          <!-- Selector -->
          <ion-select
            *ngIf="field.type === 'select'"
            [(ngModel)]="internalValues[field.key]"
            (ionChange)="onValueChange(field.key, $event.detail.value)"
            [placeholder]="field.placeholder">
            <ion-select-option [value]="null">Todos</ion-select-option>
            <ion-select-option
              *ngFor="let option of field.options"
              [value]="option.value">
              {{ option.label }}
            </ion-select-option>
          </ion-select>

          <!-- Multiselección -->
          <ion-select
            *ngIf="field.type === 'multiselect'"
            [(ngModel)]="internalValues[field.key]"
            (ionChange)="onValueChange(field.key, $event.detail.value)"
            [placeholder]="field.placeholder"
            multiple="true">
            <ion-select-option
              *ngFor="let option of field.options"
              [value]="option.value">
              {{ option.label }}
            </ion-select-option>
          </ion-select>

          <!-- Fecha -->
          <ion-input
            *ngIf="field.type === 'date'"
            type="date"
            [(ngModel)]="internalValues[field.key]"
            (ionInput)="onValueChange(field.key, $event.detail.value)">
          </ion-input>

          <!-- Rango de fechas -->
          <div *ngIf="field.type === 'daterange'" class="date-range">
            <ion-input
              type="date"
              [value]="getDateRangeValue(field.key).start"
              (ionInput)="onDateRangeChange(field.key, 'start', $event.detail.value || '')"
              placeholder="Desde">
            </ion-input>
            <ion-input
              type="date"
              [value]="getDateRangeValue(field.key).end"
              (ionInput)="onDateRangeChange(field.key, 'end', $event.detail.value || '')"
              placeholder="Hasta">
            </ion-input>
          </div>

          <!-- Booleano -->
          <ion-select
            *ngIf="field.type === 'boolean'"
            [(ngModel)]="internalValues[field.key]"
            (ionChange)="onValueChange(field.key, $event.detail.value)">
            <ion-select-option [value]="null">Todos</ion-select-option>
            <ion-select-option [value]="true">Sí</ion-select-option>
            <ion-select-option [value]="false">No</ion-select-option>
          </ion-select>
        </ion-item>
      </div>
    </div>

    <!-- Acciones -->
    <div class="filters-actions" *ngIf="!loading">
      <ion-button
        fill="outline"
        (click)="onClear()"
        [disabled]="getActiveFiltersCount() === 0">
        <ion-icon name="refresh" slot="start"></ion-icon>
        Limpiar
      </ion-button>

      <ion-button
        fill="solid"
        (click)="onApply()"
        color="secondary">
        <ion-icon name="search" slot="start"></ion-icon>
        Aplicar Filtros
      </ion-button>
    </div>

    <!-- Presets guardados -->
    <div class="presets-section" *ngIf="savedPresets.length > 0">
      <h4>Filtros guardados</h4>
      <div class="presets-list">
        <ion-chip
          *ngFor="let preset of savedPresets; let i = index"
          (click)="loadPreset(preset)"
          class="preset-chip">
          <ion-label>{{ preset.name }}</ion-label>
          <ion-icon
            name="close"
            (click)="deletePreset(i); $event.stopPropagation()">
          </ion-icon>
        </ion-chip>
      </div>
    </div>

    <!-- Botón guardar preset -->
    <div class="save-preset-section" *ngIf="config.showSavePreset && getActiveFiltersCount() > 0">
      <ion-button
        fill="clear"
        size="small"
        (click)="onSavePreset()">
        <ion-icon name="bookmark" slot="start"></ion-icon>
        Guardar Filtros
      </ion-button>
    </div>
  </ion-card-content>
</ion-card>

<!-- Modal para guardar preset -->
<ion-modal [isOpen]="showSaveDialog" (willDismiss)="onCancelSavePreset()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Guardar Filtros</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="onCancelSavePreset()">Cancelar</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content>
      <ion-item>
        <ion-label position="floating">Nombre del filtro</ion-label>
        <ion-input
          [(ngModel)]="presetName"
          placeholder="Ej: Caballos activos"
          (keyup.enter)="onConfirmSavePreset()">
        </ion-input>
      </ion-item>

      <div class="modal-actions">
        <ion-button
          expand="block"
          (click)="onConfirmSavePreset()"
          [disabled]="!presetName.trim()">
          <ion-icon name="checkmark" slot="start"></ion-icon>
          Guardar
        </ion-button>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>