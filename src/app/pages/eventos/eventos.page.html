<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home"></ion-back-button>
    </ion-buttons>
    <ion-title>Eventos del Criadero</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="cambiarVista('lista')" [color]="vistaActual === 'lista' ? 'primary' : 'medium'">
        <ion-icon name="list"></ion-icon>
      </ion-button>
      <ion-button (click)="cambiarVista('calendario')" [color]="vistaActual === 'calendario' ? 'primary' : 'medium'">
        <ion-icon name="calendar"></ion-icon>
      </ion-button>
      <ion-button (click)="cambiarVista('timeline')" [color]="vistaActual === 'timeline' ? 'primary' : 'medium'">
        <ion-icon name="time"></ion-icon>
      </ion-button>
      <ion-button *ngIf="canEdit" (click)="toggleForm()" color="success">
        <ion-icon name="add"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="eventos-content">
  <!-- Próximos Eventos Destacados -->
  <div class="proximos-eventos" *ngIf="getEventosProximosLista().length > 0">
    <h3 class="seccion-titulo">
      <ion-icon name="alarm" color="warning"></ion-icon>
      Próximos Eventos
    </h3>
    <div class="proximos-grid">
      <ion-card
        *ngFor="let evento of getEventosProximosLista()"
        class="evento-destacado-card"
        [ngClass]="getTipoClase(evento.tipo)"
        (click)="verDetalleEvento(evento)">
        <ion-card-header class="evento-header">
          <div class="evento-tipo-badge">
            <ion-icon [name]="getTipoIcono(evento.tipo)"></ion-icon>
            <span>{{ getTipoLabel(evento.tipo) }}</span>
          </div>
          <ion-chip [color]="getEstadoColor(evento.estado)" size="small">
            {{ evento.estado | titlecase }}
          </ion-chip>
        </ion-card-header>
        <ion-card-content class="evento-content">
          <h3 class="evento-titulo">{{ evento.titulo }}</h3>
          <div class="evento-info">
            <div class="info-item">
              <ion-icon name="calendar" color="primary"></ion-icon>
              <span>{{ getFechaFormateada(evento.fechaInicio) }}</span>
            </div>
            <div class="info-item" *ngIf="evento.ubicacion">
              <ion-icon name="location" color="secondary"></ion-icon>
              <span>{{ evento.ubicacion }}</span>
            </div>
            <div class="info-item" *ngIf="evento.caballoId">
              <ion-icon name="paw" color="tertiary"></ion-icon>
              <span>{{ getNombreCaballo(evento.caballoId) }}</span>
            </div>
          </div>
          <div class="evento-countdown" *ngIf="getDiasRestantes(evento.fechaInicio) >= 0">
            <ion-icon name="time" color="warning"></ion-icon>
            <span>{{ getDiasRestantes(evento.fechaInicio) }} días</span>
          </div>
        </ion-card-content>
      </ion-card>
    </div>
  </div>

  <!-- Estadísticas Mejoradas -->
  <ion-card class="stats-card-modern" *ngIf="eventosFiltrados.length > 0">
    <ion-card-content>
      <div class="stats-grid-modern">
        <div class="stat-card-modern total">
          <div class="stat-icon">
            <ion-icon name="calendar"></ion-icon>
          </div>
          <div class="stat-content">
            <h2>{{ eventosFiltrados.length }}</h2>
            <p>Eventos {{ filtrosValues['estado'] ? filtrosValues['estado'] + 's' : 'totales' }}</p>
          </div>
        </div>
        <div class="stat-card-modern proximos">
          <div class="stat-icon">
            <ion-icon name="alarm"></ion-icon>
          </div>
          <div class="stat-content">
            <h2>{{ getEventosProximos() }}</h2>
            <p>Próximos (7 días)</p>
          </div>
        </div>
        <div class="stat-card-modern completados">
          <div class="stat-icon">
            <ion-icon name="checkmark-circle"></ion-icon>
          </div>
          <div class="stat-content">
            <h2>{{ getEventosCompletados() }}</h2>
            <p>Completados</p>
          </div>
        </div>
        <div class="stat-card-modern hoy">
          <div class="stat-icon">
            <ion-icon name="today"></ion-icon>
          </div>
          <div class="stat-content">
            <h2>{{ getEventosHoy() }}</h2>
            <p>Para hoy</p>
          </div>
        </div>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Filtros avanzados -->
  <app-advanced-filters
    [config]="filtrosConfig"
    [values]="filtrosValues"
    [isExpanded]="filtrosExpanded"
    (valuesChange)="onFiltrosChange($event)"
    (toggle)="onFiltrosToggle($event)"
    (clear)="onFiltrosClear()"
    (apply)="onFiltrosApply($event)">
  </app-advanced-filters>

  <!-- Loading Spinner -->
  <div class="loading-container" *ngIf="isLoading">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Cargando eventos...</p>
  </div>

  <!-- Vista de Lista Mejorada -->
  <div *ngIf="!isLoading && vistaActual === 'lista'">
    <ion-list class="eventos-lista-modern">
      <ion-item-group *ngFor="let grupo of eventosAgrupados; trackBy: trackByFecha">
        <ion-item-divider class="fecha-divider">
          <ion-label>
            <h2>{{ grupo.fecha | date:'EEEE, dd \'de\' MMMM \'de\' yyyy' | titlecase }}</h2>
            <p>{{ grupo.eventos.length }} evento{{ grupo.eventos.length !== 1 ? 's' : '' }}</p>
          </ion-label>
        </ion-item-divider>

        <ion-card
          *ngFor="let evento of grupo.eventos"
          class="evento-card-modern"
          [ngClass]="getTipoClase(evento.tipo)"
          (click)="verDetalleEvento(evento)">

          <ion-card-header class="evento-card-header">
            <div class="evento-titulo-section">
              <div class="evento-icono">
                <ion-icon [name]="getTipoIcono(evento.tipo)"></ion-icon>
              </div>
              <div class="evento-titulo-info">
                <h3>{{ evento.titulo }}</h3>
                <p class="evento-tipo">{{ getTipoLabel(evento.tipo) }}</p>
              </div>
            </div>
            <div class="evento-actions">
              <ion-chip [color]="getEstadoColor(evento.estado)" size="small">
                {{ evento.estado | titlecase }}
              </ion-chip>
              <div class="action-buttons" *ngIf="canEdit">
                <ion-button fill="clear" size="small" (click)="editarEvento(evento); $event.stopPropagation()">
                  <ion-icon name="create" color="primary"></ion-icon>
                </ion-button>
                <ion-button fill="clear" size="small" (click)="eliminarEvento(evento.id); $event.stopPropagation()">
                  <ion-icon name="trash" color="danger"></ion-icon>
                </ion-button>
              </div>
            </div>
          </ion-card-header>

          <ion-card-content class="evento-card-content">
            <div class="evento-detalles-grid">
              <div class="detalle-item" *ngIf="evento.fechaInicio">
                <ion-icon name="time-outline" color="medium"></ion-icon>
                <span>{{ getHoraFormateada(evento.fechaInicio) }}</span>
              </div>
              <div class="detalle-item" *ngIf="evento.ubicacion">
                <ion-icon name="location-outline" color="medium"></ion-icon>
                <span>{{ evento.ubicacion }}</span>
              </div>
              <div class="detalle-item" *ngIf="evento.caballoId">
                <ion-icon name="paw-outline" color="medium"></ion-icon>
                <span>{{ getNombreCaballo(evento.caballoId) }}</span>
              </div>
              <div class="detalle-item" *ngIf="evento.responsable">
                <ion-icon name="person-outline" color="medium"></ion-icon>
                <span>{{ evento.responsable }}</span>
              </div>
              <div class="detalle-item" *ngIf="evento.costo">
                <ion-icon name="cash-outline" color="medium"></ion-icon>
                <span>${{ evento.costo }}</span>
              </div>
            </div>

            <p class="evento-descripcion" *ngIf="evento.descripcion">{{ evento.descripcion }}</p>

            <div class="evento-badges" *ngIf="evento.notas || evento.duracionHoras">
              <ion-chip *ngIf="evento.duracionHoras" color="tertiary" size="small">
                <ion-icon name="hourglass"></ion-icon>
                {{ evento.duracionHoras }}h
              </ion-chip>
              <ion-chip *ngIf="evento.notas" color="warning" size="small">
                <ion-icon name="document-text"></ion-icon>
                Notas
              </ion-chip>
            </div>
          </ion-card-content>
        </ion-card>
      </ion-item-group>
    </ion-list>
  </div>

  <!-- Vista de Calendario -->
  <div *ngIf="!isLoading && vistaActual === 'calendario'" class="calendario-vista">
    <ion-card class="calendario-card">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="calendar" slot="start"></ion-icon>
          Calendario de Eventos
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <div class="calendario-grid">
          <div class="dia-calendario"
               *ngFor="let dia of diasCalendario"
               [ngClass]="{'dia-con-eventos': dia.eventos.length > 0, 'dia-hoy': dia.esHoy}"
               (click)="seleccionarDia(dia)">
            <div class="dia-numero">{{ dia.numero }}</div>
            <div class="dia-nombre">{{ dia.nombreCorto }}</div>
            <div class="eventos-del-dia">
              <div class="evento-miniatura"
                   *ngFor="let evento of dia.eventos.slice(0, 3)"
                   [ngClass]="getTipoClase(evento.tipo)">
              </div>
              <div class="mas-eventos" *ngIf="dia.eventos.length > 3">
                +{{ dia.eventos.length - 3 }}
              </div>
            </div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Vista de Timeline -->
  <div *ngIf="!isLoading && vistaActual === 'timeline'" class="timeline-vista">
    <div class="timeline-container">
      <div class="timeline-line"></div>
      <div class="timeline-events">
        <div class="timeline-item"
             *ngFor="let evento of eventosOrdenados; trackBy: trackById"
             [ngClass]="getEstadoClase(evento.estado)">
          <div class="timeline-marker" [ngClass]="getTipoClase(evento.tipo)">
            <ion-icon [name]="getTipoIcono(evento.tipo)"></ion-icon>
          </div>
          <div class="timeline-content" (click)="verDetalleEvento(evento)">
            <div class="timeline-header">
              <h4>{{ evento.titulo }}</h4>
              <ion-chip [color]="getEstadoColor(evento.estado)" size="small">
                {{ evento.estado | titlecase }}
              </ion-chip>
            </div>
            <div class="timeline-meta">
              <span class="timeline-fecha">{{ getFechaCompleta(evento.fechaInicio) }}</span>
              <span class="timeline-tipo">{{ getTipoLabel(evento.tipo) }}</span>
            </div>
            <p class="timeline-desc" *ngIf="evento.descripcion">{{ evento.descripcion }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Formulario para Evento -->
  <ion-card *ngIf="showForm && canEdit">
    <ion-card-header>
      <ion-card-title>{{ nuevoEvento.id ? 'Editar' : 'Nuevo' }} Evento</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <form (ngSubmit)="agregarEvento()">
        <ion-item>
          <ion-input
            label="Título del evento"
            [(ngModel)]="nuevoEvento.titulo"
            name="titulo"
            required
            placeholder="Ej: Competencia Nacional">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-datetime
            label="Fecha y hora de inicio"
            [(ngModel)]="nuevoEvento.fechaInicio"
            name="fechaInicio"
            presentation="date-time"
            required>
          </ion-datetime>
        </ion-item>

        <ion-item>
          <ion-select
            label="Tipo de evento"
            [(ngModel)]="nuevoEvento.tipo"
            name="tipo"
            placeholder="Seleccionar tipo">
            <ion-select-option value="cita_veterinaria">Cita Veterinaria</ion-select-option>
            <ion-select-option value="competicion">Competición</ion-select-option>
            <ion-select-option value="entrenamiento">Entrenamiento</ion-select-option>
            <ion-select-option value="reproduccion">Reproducción</ion-select-option>
            <ion-select-option value="mantenimiento">Mantenimiento</ion-select-option>
            <ion-select-option value="otros">Otros</ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item>
          <ion-select
            label="Estado"
            [(ngModel)]="nuevoEvento.estado"
            name="estado"
            placeholder="Seleccionar estado">
            <ion-select-option value="pendiente">Pendiente</ion-select-option>
            <ion-select-option value="confirmado">Confirmado</ion-select-option>
            <ion-select-option value="completado">Completado</ion-select-option>
            <ion-select-option value="cancelado">Cancelado</ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item>
          <ion-input
            label="Descripción"
            [(ngModel)]="nuevoEvento.descripcion"
            name="descripcion"
            placeholder="Descripción del evento">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-input
            label="Ubicación"
            [(ngModel)]="nuevoEvento.ubicacion"
            name="ubicacion"
            placeholder="Lugar del evento">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-input
            label="Responsable"
            [(ngModel)]="nuevoEvento.responsable"
            name="responsable"
            placeholder="Persona responsable">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-input
            label="Costo"
            type="number"
            [(ngModel)]="nuevoEvento.costo"
            name="costo"
            placeholder="Costo estimado">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-input
            label="Duración (horas)"
            type="number"
            [(ngModel)]="nuevoEvento.duracionHoras"
            name="duracionHoras"
            placeholder="Duración en horas">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-textarea
            label="Notas"
            [(ngModel)]="nuevoEvento.notas"
            name="notas"
            placeholder="Notas adicionales"
            rows="3">
          </ion-textarea>
        </ion-item>

        <div class="ion-padding">
          <ion-button
            type="submit"
            expand="full"
            [disabled]="isLoading || !nuevoEvento.titulo || !nuevoEvento.fechaInicio">
            <ion-icon *ngIf="isLoading" name="refresh" slot="start"></ion-icon>
            {{ isLoading ? 'Guardando...' : (nuevoEvento.id ? 'Actualizar' : 'Crear') + ' Evento' }}
          </ion-button>
          <ion-button
            fill="clear"
            expand="full"
            color="medium"
            (click)="toggleForm()">
            Cancelar
          </ion-button>
        </div>
      </form>
    </ion-card-content>
  </ion-card>

  <!-- Mensaje cuando no hay eventos -->
  <ion-card *ngIf="!isLoading && eventos.length === 0">
    <ion-card-content class="ion-text-center">
      <ion-icon name="calendar-outline" size="large" color="medium"></ion-icon>
      <h3>No hay eventos</h3>
      <p>Crea tu primer evento para comenzar</p>
      <ion-button (click)="toggleForm()">
        <ion-icon name="add" slot="start"></ion-icon>
        Crear Evento
      </ion-button>
    </ion-card-content>
  </ion-card>
</ion-content>